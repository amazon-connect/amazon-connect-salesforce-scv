AWSTemplateFormatVersion: "2010-09-09"
Description: Deploys the Voicemail Express contact flows, as required.

Parameters:
  EXPTemplateVersion:
    Type: String
  ConnectInstanceAlias:
    Type: String
  ConnectInstanceARN:
    Type: String
  EnableVMToConnectTask:
    Type: String
  EnableVMToEmail:
    Type: String
  EnableVMToSalesforceCase:
    Type: String
  EnableVMToSalesforceCustomObject:
    Type: String
  VMTestAgentId:
    Type: String
  VMTestQueueARN:
    Type: String

Conditions:
  SalesforceEnabled: !Or [!Equals [!Ref EnableVMToSalesforceCase, yes], !Equals [!Ref EnableVMToSalesforceCustomObject, yes] ]
  AWSEnabled: !Or [!Equals [!Ref EnableVMToConnectTask, yes], !Equals [!Ref EnableVMToEmail, yes] ]
  ConnectTasksEnabled: !Equals [!Ref EnableVMToConnectTask, yes]
  AWSEmailEnabled: !Equals [!Ref EnableVMToEmail, yes]

Resources:
  VMXCoreFlow:
    Type: AWS::Connect::ContactFlow
    Properties:
      Content: "{\"Version\":\"2019-10-30\",\"StartAction\":\"f4c7bf69-764f-453d-8d46-fd3b6531cb96\",\"Metadata\":{\"entryPointPosition\":{\"x\":15,\"y\":15},\"snapToGrid\":false,\"ActionMetadata\":{\"a3a111be-343a-4d7d-b328-b4fdfb0aea51\":{\"position\":{\"x\":1481,\"y\":21}},\"e82c5fb7-65ca-4012-b949-a2d7d46c6773\":{\"position\":{\"x\":1001,\"y\":240},\"useDynamic\":false},\"3296b3ee-9131-483f-99bc-04611d85723d\":{\"position\":{\"x\":1701,\"y\":21},\"useDynamic\":false},\"92bc7c08-16fe-4d2d-ae11-bd4b19423938\":{\"position\":{\"x\":1482,\"y\":241}},\"bc6687db-c05b-48b1-b3f0-5c5eb360a3fc\":{\"position\":{\"x\":282,\"y\":21},\"useDynamic\":false},\"f4c7bf69-764f-453d-8d46-fd3b6531cb96\":{\"position\":{\"x\":41,\"y\":161}},\"218ff366-2cdf-468b-ab32-1a562e087725\":{\"position\":{\"x\":761,\"y\":242},\"useDynamic\":false},\"a2d9a221-cbff-408d-b9a4-bcd803045233\":{\"position\":{\"x\":521,\"y\":20},\"fromCustomer\":true,\"toCustomer\":false},\"214b4b6b-362c-4842-85ef-29625ad74c0e\":{\"position\":{\"x\":1242,\"y\":21},\"conditionMetadata\":[],\"useDynamic\":false,\"useLexBotDropdown\":true,\"useDynamicLexBotArn\":false},\"dc89e01f-89ae-4d77-ad42-8d7b2c20dd85\":{\"position\":{\"x\":761,\"y\":20},\"dynamicParams\":[]},\"f0d2e38c-7e72-4876-8920-be43ea77cca3\":{\"position\":{\"x\":1001,\"y\":20},\"useDynamic\":false}}},\"Actions\":[{\"Identifier\":\"a3a111be-343a-4d7d-b328-b4fdfb0aea51\",\"Parameters\":{\"MediaStreamingState\":\"Disabled\",\"MediaStreamType\":\"Audio\",\"Participants\":[{\"ParticipantType\":\"Customer\",\"MediaDirections\":[\"From\",\"To\"]}]},\"Transitions\":{\"NextAction\":\"3296b3ee-9131-483f-99bc-04611d85723d\",\"Errors\":[{\"NextAction\":\"3296b3ee-9131-483f-99bc-04611d85723d\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactMediaStreamingBehavior\"},{\"Identifier\":\"e82c5fb7-65ca-4012-b949-a2d7d46c6773\",\"Transitions\":{\"NextAction\":\"92bc7c08-16fe-4d2d-ae11-bd4b19423938\",\"Errors\":[{\"NextAction\":\"92bc7c08-16fe-4d2d-ae11-bd4b19423938\",\"ErrorType\":\"NoMatchingError\"},{\"NextAction\":\"92bc7c08-16fe-4d2d-ae11-bd4b19423938\",\"ErrorType\":\"QueueAtCapacity\"}],\"Conditions\":[]},\"Type\":\"TransferContactToQueue\"},{\"Identifier\":\"3296b3ee-9131-483f-99bc-04611d85723d\",\"Parameters\":{\"Text\":\"Your voicemail has been saved. Goodbye.\"},\"Transitions\":{\"NextAction\":\"92bc7c08-16fe-4d2d-ae11-bd4b19423938\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"MessageParticipant\"},{\"Identifier\":\"92bc7c08-16fe-4d2d-ae11-bd4b19423938\",\"Type\":\"DisconnectParticipant\",\"Parameters\":{},\"Transitions\":{}},{\"Identifier\":\"bc6687db-c05b-48b1-b3f0-5c5eb360a3fc\",\"Parameters\":{\"Text\":\"We will begin to record your message after the tone. When finished, you may hang up. Your voicemail will be saved and delivered to a representative.\"},\"Transitions\":{\"NextAction\":\"a2d9a221-cbff-408d-b9a4-bcd803045233\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"MessageParticipant\"},{\"Identifier\":\"f4c7bf69-764f-453d-8d46-fd3b6531cb96\",\"Parameters\":{\"FlowLoggingBehavior\":\"Enabled\"},\"Transitions\":{\"NextAction\":\"bc6687db-c05b-48b1-b3f0-5c5eb360a3fc\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"UpdateFlowLoggingBehavior\"},{\"Identifier\":\"218ff366-2cdf-468b-ab32-1a562e087725\",\"Parameters\":{\"Text\":\"The voicemail system has encountered an error. We are placing you in queue.\"},\"Transitions\":{\"NextAction\":\"e82c5fb7-65ca-4012-b949-a2d7d46c6773\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"MessageParticipant\"},{\"Identifier\":\"a2d9a221-cbff-408d-b9a4-bcd803045233\",\"Parameters\":{\"MediaStreamingState\":\"Enabled\",\"MediaStreamType\":\"Audio\",\"Participants\":[{\"ParticipantType\":\"Customer\",\"MediaDirections\":[\"From\"]}]},\"Transitions\":{\"NextAction\":\"dc89e01f-89ae-4d77-ad42-8d7b2c20dd85\",\"Errors\":[{\"NextAction\":\"218ff366-2cdf-468b-ab32-1a562e087725\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactMediaStreamingBehavior\"},{\"Identifier\":\"214b4b6b-362c-4842-85ef-29625ad74c0e\",\"Parameters\":{\"SSML\":\"<speak>\\n<break time=\\\"5s\\\"/>\\n</speak>\",\"StoreInput\":\"False\",\"InputTimeLimitSeconds\":\"60\"},\"Transitions\":{\"NextAction\":\"a3a111be-343a-4d7d-b328-b4fdfb0aea51\",\"Errors\":[{\"NextAction\":\"a3a111be-343a-4d7d-b328-b4fdfb0aea51\",\"ErrorType\":\"NoMatchingError\"},{\"NextAction\":\"a3a111be-343a-4d7d-b328-b4fdfb0aea51\",\"ErrorType\":\"NoMatchingCondition\"},{\"NextAction\":\"a3a111be-343a-4d7d-b328-b4fdfb0aea51\",\"ErrorType\":\"InputTimeLimitExceeded\"}],\"Conditions\":[]},\"Type\":\"GetParticipantInput\"},{\"Identifier\":\"dc89e01f-89ae-4d77-ad42-8d7b2c20dd85\",\"Parameters\":{\"Attributes\":{\"vm_flag\":\"1\"}},\"Transitions\":{\"NextAction\":\"f0d2e38c-7e72-4876-8920-be43ea77cca3\",\"Errors\":[{\"NextAction\":\"218ff366-2cdf-468b-ab32-1a562e087725\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactAttributes\"},{\"Identifier\":\"f0d2e38c-7e72-4876-8920-be43ea77cca3\",\"Parameters\":{\"SSML\":\"<speak>\\n  <say-as interpret-as=\\\"expletive\\\">beep</say-as>\\n</speak>\"},\"Transitions\":{\"NextAction\":\"214b4b6b-362c-4842-85ef-29625ad74c0e\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"MessageParticipant\"}]}"
      Description: Core contact flow that records the voicemail. Intended to be called from other contact flows. Please make sure that all required attributes for your voicemail delivery model are set prior to invoking this flow.
      InstanceArn:
        Ref: ConnectInstanceARN
      Name:
        !Join
          - ''
          - - 'VMXCoreFlow-'
            - !Ref ConnectInstanceAlias
      State: ACTIVE
      Type: CONTACT_FLOW

  VMXExampleTaskFlow:
    Type: AWS::Connect::ContactFlow
    Condition: ConnectTasksEnabled
    Properties:
      Content: "{\"Version\":\"2019-10-30\",\"StartAction\":\"fd70d719-29ef-4a68-acad-6f6ca1b2a47f\",\"Metadata\":{\"entryPointPosition\":{\"x\":21,\"y\":20},\"snapToGrid\":false,\"ActionMetadata\":{\"fd70d719-29ef-4a68-acad-6f6ca1b2a47f\":{\"position\":{\"x\":182,\"y\":21},\"useDynamic\":true,\"queue\":\"vm_queue_arn\"},\"118c2e2a-efbb-44b7-ba26-1265b28a9fc6\":{\"position\":{\"x\":420,\"y\":21},\"useDynamic\":false},\"efb7c932-a0ca-4ba5-9242-386137608236\":{\"position\":{\"x\":661,\"y\":21}}}},\"Actions\":[{\"Identifier\":\"fd70d719-29ef-4a68-acad-6f6ca1b2a47f\",\"Parameters\":{\"QueueId\":\"$.Attributes.vm_queue_arn\"},\"Transitions\":{\"NextAction\":\"118c2e2a-efbb-44b7-ba26-1265b28a9fc6\",\"Errors\":[{\"NextAction\":\"118c2e2a-efbb-44b7-ba26-1265b28a9fc6\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactTargetQueue\"},{\"Identifier\":\"118c2e2a-efbb-44b7-ba26-1265b28a9fc6\",\"Transitions\":{\"NextAction\":\"efb7c932-a0ca-4ba5-9242-386137608236\",\"Errors\":[{\"NextAction\":\"efb7c932-a0ca-4ba5-9242-386137608236\",\"ErrorType\":\"NoMatchingError\"},{\"NextAction\":\"efb7c932-a0ca-4ba5-9242-386137608236\",\"ErrorType\":\"QueueAtCapacity\"}],\"Conditions\":[]},\"Type\":\"TransferContactToQueue\"},{\"Identifier\":\"efb7c932-a0ca-4ba5-9242-386137608236\",\"Type\":\"DisconnectParticipant\",\"Parameters\":{},\"Transitions\":{}}]}"
      Description: Sample basic task flow for voicemail.
      InstanceArn:
        Ref: ConnectInstanceARN
      Name:
        !Join
          - ''
          - - 'VMXBasicTaskFlow-'
            - !Ref ConnectInstanceAlias
      State: ACTIVE
      Type: CONTACT_FLOW

  VMXAWSTestFlow:
    Type: AWS::Connect::ContactFlow
    Condition: AWSEnabled
    DependsOn:
        - VMXCoreFlow
    Properties:
      Content: !Sub
        - "{\"Version\":\"2019-10-30\",\"StartAction\":\"a2e856a6-b552-40be-a599-9f77fd6eb79a\",\"Metadata\":{\"entryPointPosition\":{\"x\":15,\"y\":15},\"snapToGrid\":false,\"ActionMetadata\":{\"4467aee3-29aa-4751-ad35-8072cb67c4c3\":{\"position\":{\"x\":1085,\"y\":633}},\"4c3215ff-ddd3-4cc4-a75d-901f3bfbd2e4\":{\"position\":{\"x\":2143,\"y\":291}},\"98b6cb81-6aa3-4789-8822-8aef86993087\":{\"position\":{\"x\":271,\"y\":451},\"dynamicParams\":[]},\"8e080416-7cb1-4c6a-8425-aa4a89880cf8\":{\"position\":{\"x\":321,\"y\":661},\"dynamicParams\":[]},\"8702fa50-2bea-4db0-ab87-a4b38addfffb\":{\"position\":{\"x\":22,\"y\":450},\"conditionMetadata\":[{\"id\":\"8bddf26b-8914-45f5-b173-93b50f2e70c9\",\"value\":\"1\"},{\"id\":\"7908d77b-6648-40c2-834b-e525d54f9fc2\",\"value\":\"2\"}],\"useDynamic\":false,\"useLexBotDropdown\":true,\"useDynamicLexBotArn\":false},\"d9379f61-2a8a-4ffc-8ff2-501226f63d5b\":{\"position\":{\"x\":271,\"y\":892},\"dynamicParams\":[]},\"a36f4066-a2a9-4c0e-8047-9cdb428ea4e9\":{\"position\":{\"x\":843,\"y\":337},\"useDynamic\":true,\"queue\":\"vm_test_queue\"},\"918bce19-adbf-43ba-9c13-f9d6d14af047\":{\"position\":{\"x\":813,\"y\":636},\"useDynamic\":false},\"61b6b994-ec54-4356-8630-252400abedbd\":{\"position\":{\"x\":545,\"y\":124},\"conditionMetadata\":[{\"id\":\"6fe6f001-a67d-42b7-9112-1c2d9d0c2599\",\"value\":\"1\"},{\"id\":\"694a3844-b7f5-4dc2-b0f2-04fb99df5406\",\"value\":\"2\"}],\"useDynamic\":false,\"useLexBotDropdown\":true,\"useDynamicLexBotArn\":false},\"39b2f5a6-cf05-48e8-bbff-bcba44222485\":{\"position\":{\"x\":844,\"y\":127},\"useDynamic\":true,\"queue\":\"vm_test_agent\"},\"c9711647-8de0-41bf-96c7-753185e659a3\":{\"position\":{\"x\":1185,\"y\":292},\"useDynamic\":false},\"1b3e66c4-9686-4b35-81d1-acd1f7ea3c3c\":{\"position\":{\"x\":264,\"y\":272},\"useDynamic\":false},\"a2e856a6-b552-40be-a599-9f77fd6eb79a\":{\"position\":{\"x\":19,\"y\":271}},\"59ee2599-4cf7-4eb9-a764-4ef49a7b19b4\":{\"position\":{\"x\":260,\"y\":45},\"dynamicParams\":[]},\"08a51b26-8b7f-4a43-a57f-116edb606ce8\":{\"position\":{\"x\":1905,\"y\":292},\"useDynamic\":false},\"dfa0b76f-d163-44ab-bf9d-6a8d2b76b092\":{\"position\":{\"x\":1424,\"y\":291},\"dynamicParams\":[\"vm_queue_arn\",\"vm_from\"]},\"2d4ffa7b-4a78-4c14-a2ce-63fce8bc257b\":{\"position\":{\"x\":1664,\"y\":291},\"useDynamic\":true}}},\"Actions\":[{\"Identifier\":\"4467aee3-29aa-4751-ad35-8072cb67c4c3\",\"Type\":\"DisconnectParticipant\",\"Parameters\":{},\"Transitions\":{}},{\"Identifier\":\"4c3215ff-ddd3-4cc4-a75d-901f3bfbd2e4\",\"Type\":\"DisconnectParticipant\",\"Parameters\":{},\"Transitions\":{}},{\"Identifier\":\"98b6cb81-6aa3-4789-8822-8aef86993087\",\"Parameters\":{\"Attributes\":{\"vm_mode\":\"task\"}},\"Transitions\":{\"NextAction\":\"61b6b994-ec54-4356-8630-252400abedbd\",\"Errors\":[{\"NextAction\":\"61b6b994-ec54-4356-8630-252400abedbd\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactAttributes\"},{\"Identifier\":\"8e080416-7cb1-4c6a-8425-aa4a89880cf8\",\"Parameters\":{\"Attributes\":{\"vm_mode\":\"email\"}},\"Transitions\":{\"NextAction\":\"61b6b994-ec54-4356-8630-252400abedbd\",\"Errors\":[{\"NextAction\":\"61b6b994-ec54-4356-8630-252400abedbd\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactAttributes\"},{\"Identifier\":\"8702fa50-2bea-4db0-ab87-a4b38addfffb\",\"Parameters\":{\"Text\":\"Press 1 to test voicemail to task. Press 2 to test voicemail to e-mail.\",\"StoreInput\":\"False\",\"InputTimeLimitSeconds\":\"5\"},\"Transitions\":{\"NextAction\":\"d9379f61-2a8a-4ffc-8ff2-501226f63d5b\",\"Errors\":[{\"NextAction\":\"d9379f61-2a8a-4ffc-8ff2-501226f63d5b\",\"ErrorType\":\"NoMatchingError\"},{\"NextAction\":\"d9379f61-2a8a-4ffc-8ff2-501226f63d5b\",\"ErrorType\":\"NoMatchingCondition\"},{\"NextAction\":\"d9379f61-2a8a-4ffc-8ff2-501226f63d5b\",\"ErrorType\":\"InputTimeLimitExceeded\"}],\"Conditions\":[{\"NextAction\":\"98b6cb81-6aa3-4789-8822-8aef86993087\",\"Condition\":{\"Operator\":\"Equals\",\"Operands\":[\"1\"]}},{\"NextAction\":\"8e080416-7cb1-4c6a-8425-aa4a89880cf8\",\"Condition\":{\"Operator\":\"Equals\",\"Operands\":[\"2\"]}}]},\"Type\":\"GetParticipantInput\"},{\"Identifier\":\"d9379f61-2a8a-4ffc-8ff2-501226f63d5b\",\"Parameters\":{\"Attributes\":{\"vm_mode\":\"task\"}},\"Transitions\":{\"NextAction\":\"61b6b994-ec54-4356-8630-252400abedbd\",\"Errors\":[{\"NextAction\":\"61b6b994-ec54-4356-8630-252400abedbd\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactAttributes\"},{\"Identifier\":\"a36f4066-a2a9-4c0e-8047-9cdb428ea4e9\",\"Parameters\":{\"QueueId\":\"$.Attributes.vm_test_queue\"},\"Transitions\":{\"NextAction\":\"c9711647-8de0-41bf-96c7-753185e659a3\",\"Errors\":[{\"NextAction\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactTargetQueue\"},{\"Identifier\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"Parameters\":{\"Text\":\"We have encountered a system error. One moment while we find a representative.\"},\"Transitions\":{\"NextAction\":\"4467aee3-29aa-4751-ad35-8072cb67c4c3\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"MessageParticipant\"},{\"Identifier\":\"61b6b994-ec54-4356-8630-252400abedbd\",\"Parameters\":{\"Text\":\"Press 1 to test an agent voicemail. Press 2 to test a queue voicemail.\",\"StoreInput\":\"False\",\"InputTimeLimitSeconds\":\"5\"},\"Transitions\":{\"NextAction\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"Errors\":[{\"NextAction\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"ErrorType\":\"NoMatchingError\"},{\"NextAction\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"ErrorType\":\"NoMatchingCondition\"},{\"NextAction\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"ErrorType\":\"InputTimeLimitExceeded\"}],\"Conditions\":[{\"NextAction\":\"39b2f5a6-cf05-48e8-bbff-bcba44222485\",\"Condition\":{\"Operator\":\"Equals\",\"Operands\":[\"1\"]}},{\"NextAction\":\"a36f4066-a2a9-4c0e-8047-9cdb428ea4e9\",\"Condition\":{\"Operator\":\"Equals\",\"Operands\":[\"2\"]}}]},\"Type\":\"GetParticipantInput\"},{\"Identifier\":\"39b2f5a6-cf05-48e8-bbff-bcba44222485\",\"Parameters\":{\"AgentId\":\"$.Attributes.vm_test_agent\"},\"Transitions\":{\"NextAction\":\"c9711647-8de0-41bf-96c7-753185e659a3\",\"Errors\":[{\"NextAction\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactTargetQueue\"},{\"Identifier\":\"c9711647-8de0-41bf-96c7-753185e659a3\",\"Parameters\":{\"Text\":\"Connecting to voicemail\"},\"Transitions\":{\"NextAction\":\"dfa0b76f-d163-44ab-bf9d-6a8d2b76b092\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"MessageParticipant\"},{\"Identifier\":\"1b3e66c4-9686-4b35-81d1-acd1f7ea3c3c\",\"Parameters\":{\"Text\":\"This is the voicemail express test flow.\"},\"Transitions\":{\"NextAction\":\"8702fa50-2bea-4db0-ab87-a4b38addfffb\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"MessageParticipant\"},{\"Identifier\":\"a2e856a6-b552-40be-a599-9f77fd6eb79a\",\"Parameters\":{\"FlowLoggingBehavior\":\"Enabled\"},\"Transitions\":{\"NextAction\":\"59ee2599-4cf7-4eb9-a764-4ef49a7b19b4\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"UpdateFlowLoggingBehavior\"},{\"Identifier\":\"59ee2599-4cf7-4eb9-a764-4ef49a7b19b4\",\"Parameters\":{\"Attributes\":{\"vm_core_flow\":\"${VMCOREFLOW}\",\"vm_task_flow\":\"${VMTASKFLOW}\",\"vm_test_agent\":\"${VMTESTAGENTID}\",\"vm_test_queue\":\"${VMTESTQUEUENAME}\"}},\"Transitions\":{\"NextAction\":\"1b3e66c4-9686-4b35-81d1-acd1f7ea3c3c\",\"Errors\":[{\"NextAction\":\"1b3e66c4-9686-4b35-81d1-acd1f7ea3c3c\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactAttributes\"},{\"Identifier\":\"08a51b26-8b7f-4a43-a57f-116edb606ce8\",\"Parameters\":{\"Text\":\"We have encountered a system error. One moment while we find a representative.\"},\"Transitions\":{\"NextAction\":\"4c3215ff-ddd3-4cc4-a75d-901f3bfbd2e4\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"MessageParticipant\"},{\"Identifier\":\"dfa0b76f-d163-44ab-bf9d-6a8d2b76b092\",\"Parameters\":{\"Attributes\":{\"vm_from\":\"$.CustomerEndpoint.Address\",\"vm_lang\":\"en-US\",\"vm_queue_arn\":\"$.Queue.ARN\"}},\"Transitions\":{\"NextAction\":\"2d4ffa7b-4a78-4c14-a2ce-63fce8bc257b\",\"Errors\":[{\"NextAction\":\"2d4ffa7b-4a78-4c14-a2ce-63fce8bc257b\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactAttributes\"},{\"Identifier\":\"2d4ffa7b-4a78-4c14-a2ce-63fce8bc257b\",\"Parameters\":{\"ContactFlowId\":\"$.Attributes.vm_core_flow\"},\"Transitions\":{\"NextAction\":\"08a51b26-8b7f-4a43-a57f-116edb606ce8\",\"Errors\":[{\"NextAction\":\"08a51b26-8b7f-4a43-a57f-116edb606ce8\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"TransferToFlow\"}]}"
        - VMTESTAGENTID: !Ref VMTestAgentId
          VMTESTQUEUENAME: !Ref VMTestQueueARN
          VMTASKFLOW:
            !If
              - ConnectTasksEnabled
              - !Select [1, !Split ["contact-flow/", !Ref VMXExampleTaskFlow]]
              - EXAMPLE
          VMCOREFLOW: !Ref VMXCoreFlow
      Description: Test flow for voicemail express that allows testing of both email and tasks.
      InstanceArn:
        Ref: ConnectInstanceARN
      Name:
        !Join
          - ''
          - - 'VMXAWSTestFlow-'
            - !Ref ConnectInstanceAlias
      State: ACTIVE
      Type: CONTACT_FLOW

  VMXSFDCTestFlow:
    Type: AWS::Connect::ContactFlow
    Condition: SalesforceEnabled
    DependsOn:
        - VMXCoreFlow
    Properties:
      Content: !Sub
        - "{\"Version\":\"2019-10-30\",\"StartAction\":\"a2e856a6-b552-40be-a599-9f77fd6eb79a\",\"Metadata\":{\"entryPointPosition\":{\"x\":15,\"y\":23.14705467224121},\"snapToGrid\":false,\"ActionMetadata\":{\"4c3215ff-ddd3-4cc4-a75d-901f3bfbd2e4\":{\"position\":{\"x\":2521.745849609375,\"y\":244.82968139648438}},\"39b2f5a6-cf05-48e8-bbff-bcba44222485\":{\"position\":{\"x\":862,\"y\":17},\"useDynamic\":true,\"queue\":\"vm_test_agent\"},\"c8febd85-dc5a-4bc5-938f-bf2bae3b51e1\":{\"position\":{\"x\":1143.5919189453125,\"y\":20.241195678710938},\"dynamicParams\":[]},\"99aa3e2f-4e55-48fc-8787-22a3432a359e\":{\"position\":{\"x\":1142,\"y\":248},\"useDynamic\":false},\"a40ce477-eecb-40df-8119-4327ecf4fc67\":{\"position\":{\"x\":1468,\"y\":253}},\"e166895b-927a-40da-9c62-10f78417f205\":{\"position\":{\"x\":1465.4296875,\"y\":20.241195678710938},\"useDynamic\":false},\"c9711647-8de0-41bf-96c7-753185e659a3\":{\"position\":{\"x\":1466,\"y\":431},\"useDynamic\":false},\"08a51b26-8b7f-4a43-a57f-116edb606ce8\":{\"position\":{\"x\":2275.167236328125,\"y\":243.08090209960938},\"useDynamic\":false},\"dfa0b76f-d163-44ab-bf9d-6a8d2b76b092\":{\"position\":{\"x\":1760,\"y\":244},\"dynamicParams\":[\"vm_queue_arn\",\"vm_queue_name\",\"vm_from\"]},\"2d4ffa7b-4a78-4c14-a2ce-63fce8bc257b\":{\"position\":{\"x\":2021,\"y\":249},\"useDynamic\":true},\"4467aee3-29aa-4751-ad35-8072cb67c4c3\":{\"position\":{\"x\":1144,\"y\":768}},\"447c47da-ab13-4410-985d-4d4944fc8920\":{\"position\":{\"x\":1142.603515625,\"y\":432.6309509277344},\"dynamicParams\":[]},\"61b6b994-ec54-4356-8630-252400abedbd\":{\"position\":{\"x\":562,\"y\":14},\"conditionMetadata\":[{\"id\":\"38bfdf8f-af46-4946-8a68-ad3e06230e9e\",\"value\":\"1\"},{\"id\":\"bafc1f44-dfa9-4492-a11b-fbf34dd23dbd\",\"value\":\"2\"}],\"useDynamic\":false,\"useDynamicLexBotArn\":false},\"a36f4066-a2a9-4c0e-8047-9cdb428ea4e9\":{\"position\":{\"x\":863,\"y\":427.9662107803701},\"useDynamic\":true,\"queue\":\"vm_test_queue\"},\"b3f2b2be-30d8-40f4-addf-b5aabd684d33\":{\"position\":{\"x\":267,\"y\":425},\"dynamicParams\":[]},\"ae757e99-23fc-4fcb-93c1-d28f9d774f25\":{\"position\":{\"x\":263,\"y\":638},\"dynamicParams\":[]},\"918bce19-adbf-43ba-9c13-f9d6d14af047\":{\"position\":{\"x\":792,\"y\":797},\"useDynamic\":false},\"24fac637-e75f-40e6-bd22-02cca001914c\":{\"position\":{\"x\":14,\"y\":542},\"conditionMetadata\":[{\"id\":\"0851bc5a-c1e7-457d-b0d5-d8ad5dd68ed0\",\"value\":\"1\"},{\"id\":\"35670bc2-679c-4fac-a7d7-744653f2b560\",\"value\":\"2\"}],\"useDynamic\":false,\"useLexBotDropdown\":true,\"useDynamicLexBotArn\":false},\"1b3e66c4-9686-4b35-81d1-acd1f7ea3c3c\":{\"position\":{\"x\":265,\"y\":232},\"useDynamic\":false},\"a2e856a6-b552-40be-a599-9f77fd6eb79a\":{\"position\":{\"x\":21,\"y\":180}},\"f8569fff-5ff4-49bb-994d-d907d763a1ff\":{\"position\":{\"x\":266,\"y\":13},\"dynamicParams\":[]}}},\"Actions\":[{\"Identifier\":\"4c3215ff-ddd3-4cc4-a75d-901f3bfbd2e4\",\"Type\":\"DisconnectParticipant\",\"Parameters\":{},\"Transitions\":{}},{\"Identifier\":\"39b2f5a6-cf05-48e8-bbff-bcba44222485\",\"Parameters\":{\"AgentId\":\"$.Attributes.vm_test_agent\"},\"Transitions\":{\"NextAction\":\"c8febd85-dc5a-4bc5-938f-bf2bae3b51e1\",\"Errors\":[{\"NextAction\":\"99aa3e2f-4e55-48fc-8787-22a3432a359e\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactTargetQueue\"},{\"Identifier\":\"c8febd85-dc5a-4bc5-938f-bf2bae3b51e1\",\"Parameters\":{\"Attributes\":{\"vm_queue_type\":\"agent\"}},\"Transitions\":{\"NextAction\":\"e166895b-927a-40da-9c62-10f78417f205\",\"Errors\":[{\"NextAction\":\"99aa3e2f-4e55-48fc-8787-22a3432a359e\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactAttributes\"},{\"Identifier\":\"99aa3e2f-4e55-48fc-8787-22a3432a359e\",\"Parameters\":{\"Text\":\"We have encountered a system error. One moment while we find a representative.\"},\"Transitions\":{\"NextAction\":\"a40ce477-eecb-40df-8119-4327ecf4fc67\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"MessageParticipant\"},{\"Identifier\":\"a40ce477-eecb-40df-8119-4327ecf4fc67\",\"Type\":\"DisconnectParticipant\",\"Parameters\":{},\"Transitions\":{}},{\"Identifier\":\"e166895b-927a-40da-9c62-10f78417f205\",\"Parameters\":{\"Text\":\"Connecting to agent voicemail.\"},\"Transitions\":{\"NextAction\":\"dfa0b76f-d163-44ab-bf9d-6a8d2b76b092\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"MessageParticipant\"},{\"Identifier\":\"c9711647-8de0-41bf-96c7-753185e659a3\",\"Parameters\":{\"Text\":\"Connecting to voicemail\"},\"Transitions\":{\"NextAction\":\"dfa0b76f-d163-44ab-bf9d-6a8d2b76b092\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"MessageParticipant\"},{\"Identifier\":\"08a51b26-8b7f-4a43-a57f-116edb606ce8\",\"Parameters\":{\"Text\":\"We have encountered a system error. One moment while we find a representative.\"},\"Transitions\":{\"NextAction\":\"4c3215ff-ddd3-4cc4-a75d-901f3bfbd2e4\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"MessageParticipant\"},{\"Identifier\":\"dfa0b76f-d163-44ab-bf9d-6a8d2b76b092\",\"Parameters\":{\"Attributes\":{\"vm_priority\":\"Low\",\"vm_from\":\"$.CustomerEndpoint.Address\",\"vm_lang\":\"en-US\",\"vm_queue_arn\":\"$.Queue.ARN\",\"vm_queue_name\":\"$.Queue.Name\"}},\"Transitions\":{\"NextAction\":\"2d4ffa7b-4a78-4c14-a2ce-63fce8bc257b\",\"Errors\":[{\"NextAction\":\"2d4ffa7b-4a78-4c14-a2ce-63fce8bc257b\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactAttributes\"},{\"Identifier\":\"2d4ffa7b-4a78-4c14-a2ce-63fce8bc257b\",\"Parameters\":{\"ContactFlowId\":\"$.Attributes.vm_core_flow\"},\"Transitions\":{\"NextAction\":\"08a51b26-8b7f-4a43-a57f-116edb606ce8\",\"Errors\":[{\"NextAction\":\"08a51b26-8b7f-4a43-a57f-116edb606ce8\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"TransferToFlow\"},{\"Identifier\":\"4467aee3-29aa-4751-ad35-8072cb67c4c3\",\"Type\":\"DisconnectParticipant\",\"Parameters\":{},\"Transitions\":{}},{\"Identifier\":\"447c47da-ab13-4410-985d-4d4944fc8920\",\"Parameters\":{\"Attributes\":{\"vm_queue_type\":\"queue\"}},\"Transitions\":{\"NextAction\":\"c9711647-8de0-41bf-96c7-753185e659a3\",\"Errors\":[{\"NextAction\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactAttributes\"},{\"Identifier\":\"61b6b994-ec54-4356-8630-252400abedbd\",\"Parameters\":{\"Text\":\"Press 1 to test a direct to agent voice mail. Press 2 to test a queue voicemail.\",\"StoreInput\":\"False\",\"InputTimeLimitSeconds\":\"5\"},\"Transitions\":{\"NextAction\":\"a36f4066-a2a9-4c0e-8047-9cdb428ea4e9\",\"Errors\":[{\"NextAction\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"ErrorType\":\"NoMatchingError\"},{\"NextAction\":\"a36f4066-a2a9-4c0e-8047-9cdb428ea4e9\",\"ErrorType\":\"NoMatchingCondition\"},{\"NextAction\":\"a36f4066-a2a9-4c0e-8047-9cdb428ea4e9\",\"ErrorType\":\"InputTimeLimitExceeded\"}],\"Conditions\":[{\"NextAction\":\"39b2f5a6-cf05-48e8-bbff-bcba44222485\",\"Condition\":{\"Operator\":\"Equals\",\"Operands\":[\"1\"]}},{\"NextAction\":\"a36f4066-a2a9-4c0e-8047-9cdb428ea4e9\",\"Condition\":{\"Operator\":\"Equals\",\"Operands\":[\"2\"]}}]},\"Type\":\"GetParticipantInput\"},{\"Identifier\":\"a36f4066-a2a9-4c0e-8047-9cdb428ea4e9\",\"Parameters\":{\"QueueId\":\"$.Attributes.vm_test_queue\"},\"Transitions\":{\"NextAction\":\"447c47da-ab13-4410-985d-4d4944fc8920\",\"Errors\":[{\"NextAction\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactTargetQueue\"},{\"Identifier\":\"b3f2b2be-30d8-40f4-addf-b5aabd684d33\",\"Parameters\":{\"Attributes\":{\"vm_mode\":\"sfcase\"}},\"Transitions\":{\"NextAction\":\"61b6b994-ec54-4356-8630-252400abedbd\",\"Errors\":[{\"NextAction\":\"61b6b994-ec54-4356-8630-252400abedbd\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactAttributes\"},{\"Identifier\":\"ae757e99-23fc-4fcb-93c1-d28f9d774f25\",\"Parameters\":{\"Attributes\":{\"vm_mode\":\"sfother\"}},\"Transitions\":{\"NextAction\":\"61b6b994-ec54-4356-8630-252400abedbd\",\"Errors\":[{\"NextAction\":\"61b6b994-ec54-4356-8630-252400abedbd\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactAttributes\"},{\"Identifier\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"Parameters\":{\"Text\":\"We have encountered a system error. One moment while we find a representative.\"},\"Transitions\":{\"NextAction\":\"4467aee3-29aa-4751-ad35-8072cb67c4c3\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"MessageParticipant\"},{\"Identifier\":\"24fac637-e75f-40e6-bd22-02cca001914c\",\"Parameters\":{\"Text\":\"Press 1 to test voicemail to case. Press 2 to test voicemail to a custom object.\",\"StoreInput\":\"False\",\"InputTimeLimitSeconds\":\"5\"},\"Transitions\":{\"NextAction\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"Errors\":[{\"NextAction\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"ErrorType\":\"NoMatchingError\"},{\"NextAction\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"ErrorType\":\"NoMatchingCondition\"},{\"NextAction\":\"918bce19-adbf-43ba-9c13-f9d6d14af047\",\"ErrorType\":\"InputTimeLimitExceeded\"}],\"Conditions\":[{\"NextAction\":\"b3f2b2be-30d8-40f4-addf-b5aabd684d33\",\"Condition\":{\"Operator\":\"Equals\",\"Operands\":[\"1\"]}},{\"NextAction\":\"ae757e99-23fc-4fcb-93c1-d28f9d774f25\",\"Condition\":{\"Operator\":\"Equals\",\"Operands\":[\"2\"]}}]},\"Type\":\"GetParticipantInput\"},{\"Identifier\":\"1b3e66c4-9686-4b35-81d1-acd1f7ea3c3c\",\"Parameters\":{\"Text\":\"This is the voicemail test flow.\"},\"Transitions\":{\"NextAction\":\"24fac637-e75f-40e6-bd22-02cca001914c\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"MessageParticipant\"},{\"Identifier\":\"a2e856a6-b552-40be-a599-9f77fd6eb79a\",\"Parameters\":{\"FlowLoggingBehavior\":\"Enabled\"},\"Transitions\":{\"NextAction\":\"f8569fff-5ff4-49bb-994d-d907d763a1ff\",\"Errors\":[],\"Conditions\":[]},\"Type\":\"UpdateFlowLoggingBehavior\"},{\"Identifier\":\"f8569fff-5ff4-49bb-994d-d907d763a1ff\",\"Parameters\":{\"Attributes\":{\"vm_core_flow\":\"${VMCOREFLOW}\",\"vm_test_agent\":\"${VMTESTAGENTID}\",\"vm_test_queue\":\"${VMTESTQUEUENAME}\"}},\"Transitions\":{\"NextAction\":\"1b3e66c4-9686-4b35-81d1-acd1f7ea3c3c\",\"Errors\":[{\"NextAction\":\"1b3e66c4-9686-4b35-81d1-acd1f7ea3c3c\",\"ErrorType\":\"NoMatchingError\"}],\"Conditions\":[]},\"Type\":\"UpdateContactAttributes\"}]}"
        - VMTESTAGENTID: !Ref VMTestAgentId
          VMTESTQUEUENAME: !Ref VMTestQueueARN
          VMCOREFLOW: !Ref VMXCoreFlow
      Description: Test flow for voicemail express that allows testing of both Salesforce cases and custom objects.
      InstanceArn:
        Ref: ConnectInstanceARN
      Name:
        !Join
          - ''
          - - 'VMXSFDCTestFlow-'
            - !Ref ConnectInstanceAlias
      State: ACTIVE
      Type: CONTACT_FLOW

Outputs:
    VMXExampleTaskFlowID:
      Description: ID of the tasks sample contact flow
      Condition: ConnectTasksEnabled
      Value: !Select [1, !Split ["contact-flow/", !Ref VMXExampleTaskFlow]]
